<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Ajuda">
  <meta name="keywords" content="HTML,CSS,XML,JavaScript">
  <meta name="author" content="Erick Weil">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Portugol Web</title>
	<link rel="stylesheet" type="text/css" href="portugol.css">
</head>
<body style="margin:0">
<!--<div id="EditorContainer" style="position:relative;width:100%;height:500px;margin:0;padding:0;overflow:none">-->
<!--
	funcao hhh()
	{
		inteiro a
		escreva("insira um valor:")
		leia(a)
		escreva("você inseriu:"+a+"\n\n")
		inteiro v
		//          5 * 5 + 2 * 3, ... (5 * 5) + (2 * 3) = 25 + 6 = 31
		v = 5 * 5 + 2 * 3
		escreva(v+" == 31\n")
		//           1 - - 1, ... 1 - (-1) = 2
		v = 1 - - 1
		escreva(v+" == 2\n")
		//           -1 + 1,  ... (-1) + 1 = 0
		v = -1 + 1
		escreva(v+" == 0\n")
		//           - -1 + 1,  ... (-(-1)) + 1 = 2
		v = - -1 + 1
		escreva(v+" == 2\n")
		//          - - -1 + 1,  ... (-(-(-1))) + 1 = 0
		v = - - -1 + 1
		escreva(v+" == 0\n")
		//   2 * 2 * 2 + 1 ... (2 * (2 * 2)) + 1 = 9
		v = 2 * 2 * 2 + 1
		escreva(v+" == 9\n")
		
		//  -a++ = -(a++)
		v = 1
		v = -v++
		escreva(v+" == -2\n")
	}
-->
<div id="myEditor">programa 
{
	funcao inicio()
	{
		inteiro idade
		
		escreva("Digite sua idade: ")
		leia(idade)
		
		escreva("um terço da sua idade é:"+ idade / 3) // experimente com 3.0
	}
}
</div>
<div id="myOutput" style="position:relative;">
<div class="portugol-buttons">
<input type="button" id="btn-run" value="Executar" onclick="executar(this)"/>

<input type="button" id="btn-fonteMaior" value="A+" onclick="fonteAumentar()"/>
<input type="button" id="btn-fonteMenor" value="A-" onclick="fonteDiminuir()"/>
</div>
<div class="saida" id="saida"><div id="errorArea"></div><textarea id="textAreaSaida" onclick="cursorToEnd(this)" onkeyup="cursorToEnd(this)" oninput="receiveInput(this)">??</textarea></div>
<div class="saida" id="hidden"></div>
<input type="button" value="mostrar bytecode" style="position:absolute;top:0px;right:0px;background:transparent;z-index: 5;border:none" onclick="document.getElementById('hidden').style.display = 'block';"/>
</div>
<script src="tokenizer.js"></script> <!-- Quebra o texto [para, , tokens, certinho]-->
<script src="parser.js"></script> <!-- pega os tokens e constroi a árvore -->

<!--<script src="interpreter.js"></script>-->
<script src="vm.js"></script> <!-- executa o 'bytecode' -->
<script src="vmcompiler.js"></script> <!-- compila a árvore em 'bytecode' ( parecido com java só que não é java ) -->

<!--<script src="treeview.js"></script>< ! - -  para visuzalizar a árvore -->
<script src="src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script src="ace_portugol.js"></script>
<script>


	//var codigo = document.getElementById("myEditor");
	var saida = document.getElementById("textAreaSaida");
	var errosSaida =document.getElementById("errorArea");
//for( var i = 0;i< codigos.length;i++)
//{
	//var div_port = codigo;
	var div_saida = saida;
	//var string_cod = decodeEntities(div_port.innerHTML);
	var fontSize = 10;
	if(window.innerWidth <= 600) {
		fontSize = 7;
	}
    var editor = ace.edit("myEditor",{
			minLines: 10,
			fontSize: fontSize+"pt"
		}
	);
    editor.setTheme("ace/theme/portugol_dark");
    editor.session.setMode("ace/mode/portugol");
	if(window.innerWidth <= 600) {
		editor.renderer.setShowGutter(false);
	}
	
	var errosAnnot = [];
	
	function limparErros()
	{
		errosSaida.innerHTML = "";
		errosAnnot = [];
		editor.getSession().setAnnotations(errosAnnot);
	}
	
	function enviarErro(textInput,token,msg)
	{
		var lineNumber = numberOfLinesUntil(token.index,textInput);
		var prev_line = textInput.substring(textInput.lastIndexOf('\n', token.index)+1,token.index).replace(/\t/g,'    ');
		var next_line = textInput.substring(token.index,textInput.indexOf('\n', token.index));
		var colNumber = prev_line.length;
		var logprev = "Linha "+lineNumber+":"+prev_line;
		console.log(msg);
		_enviarErro(lineNumber,colNumber,msg);
		errosSaida.innerHTML += htmlEntities(msg)+"\n";
		errosSaida.innerHTML += htmlEntities(logprev+next_line)+"\n";
		errosSaida.innerHTML += " ".repeat(logprev.length)+"^\n\n";
	}
	
	function _enviarErro(linha,coluna,msg)
	{
		errosAnnot.push({
		  row: linha-1,
		  column: coluna,
		  text: msg, // Or the Json reply from the parser 
		  type: "error" // also warning and information
		});
		editor.getSession().setAnnotations(errosAnnot);
	}
	
	function cursorToEnd(textarea)
	{
		var txtEnd =textarea.value.length;
		textarea.selectionStart= txtEnd;
		textarea.selectionEnd= txtEnd;
	}
	
	function fonteAumentar()
	{
		fontSize++;
		editor.setOptions({
		  fontSize: fontSize+"pt"
		});
	}
	
	function fonteDiminuir()
	{
		fontSize--;
		editor.setOptions({
		  fontSize: fontSize+"pt"
		});
	}
	
	//alert(string_cod);
	//div_port.innerHTML = token_replace(string_cod);
	/*function executar()
	{
		limparErros();
		var string_cod = editor.getValue();
		
		var tokenizer = new Tokenizer(string_cod);
		console.log(tokenizer.tokenize());
		
		//div_port.innerHTML = tokenizer.formatHTML();
		
		var relevantTokens = tokenizer.getRelevantTokens();
		var tree = new Parser(relevantTokens,string_cod).parse();
		console.log(tree.funcoes[0].statements);
		
		var interpreter = new Interpreter(tree,relevantTokens,string_cod,div_saida);
		interpreter.run();
	}*/
	
	//var lastvm = false;
	var lastvmState = STATE_ENDED;
	var lastvmTime = 0;
	function executar(btn)
	{
		if(btn.value == "Executar" && lastvmState == STATE_ENDED)
		{
			btn.value = "Parar";
		
			limparErros();
			var string_cod = editor.getValue();
			
			var tokenizer = new Tokenizer(string_cod);
			console.log(tokenizer.tokenize());
			
			//div_port.innerHTML = tokenizer.formatHTML();
			
			var relevantTokens = tokenizer.getRelevantTokens();
			var tree = new Parser(relevantTokens,string_cod).parse();
			console.log(tree);
			
			var compiler = new Compiler(tree,relevantTokens,string_cod,div_saida);
			compiler.compile();
			
			//lastvm = new Vm(compiler.functions,string_cod,div_saida);
			VMsetup(compiler.functions,compiler.globalCount,string_cod,div_saida);
			document.getElementById("hidden").innerHTML = VMtoString();
			//lastvmState = lastvm.run();
			lastvmTime = performance.now();
			executarVM();
		}
		else if(btn.value == "Parar" && (lastvmState == STATE_RUNNING || lastvmState == STATE_WAITINGINPUT || lastvmState == STATE_BREATHING))
		{
			btn.value = "Parando...";
			if(lastvmState == STATE_WAITINGINPUT)
			{
				escreva("\n\nPrograma interrompido pelo usuário. Tempo de execução:"+Math.trunc(performance.now()-lastvmTime)+" milissegundos");
				executarParou();
			}
			else if(lastvmState == STATE_RUNNING || lastvmState == STATE_BREATHING)
			{
				lastvmState = STATE_PENDINGSTOP;
			}
			else
			{
				console.log("botão estava em estado inconsistente: lastvmState:'"+lastvmState+"' e valor:'"+btn.value+"'");
			}
		}
		else if(btn.value == "Parando..." && lastvmState == STATE_PENDINGSTOP)
		{
			// ta idaí?
			lastvmState = STATE_PENDINGSTOP; // só para confirmar
		}
		else // para deixar o botao do jeito certo, e corrigir no caso de algum erro.
		{
			console.log("botão estava em estado inconsistente: lastvmState:'"+lastvmState+"' e valor:'"+btn.value+"'");
			if(lastvmState == STATE_ENDED) btn.value = "Executar";
			else if(lastvmState == STATE_PENDINGSTOP) btn.value = "Parando...";
			else btn.value = "Parar";
		}
	}
	
	function executarParou()
	{
		lastvmState = STATE_ENDED;
		document.getElementById("btn-run").value = "Executar";
	}
	
	function executarVM()
	{
		if(lastvmState == STATE_PENDINGSTOP) {
			// blz então
			escreva("\n\nPrograma interrompido pelo usuário. Tempo de execução:"+Math.trunc(performance.now()-lastvmTime)+" milissegundos");
			executarParou();
			return;
		}
		lastvmState = STATE_RUNNING;
		lastvmState = VMrun();
		//VM_saidaDiv.value = VM_saida;
		if(lastvmState == STATE_ENDED)
		{
			escreva("\n\nPrograma finalizado. Tempo de execução:"+Math.trunc(performance.now()-lastvmTime)+" milissegundos");
			executarParou();
		}
		else if(lastvmState == STATE_WAITINGINPUT) {
			div_saida.focus();
			cursorToEnd(div_saida);
		}
		else if(lastvmState == STATE_BREATHING) {
			setTimeout(executarVM, 1); // permite o navegador ficar responsivo
		}
	}
	
	function receiveInput(textarea)
	{
		if(lastvmState == STATE_WAITINGINPUT)
		{
			var saidadiv = textarea.value;
			var entrada = saidadiv.substring(VM_saida.length,saidadiv.length);
			
			if(entrada.endsWith("\n"))
			{
				executarVM();
			}
		}
		else
		{
			div_saida.value = VM_saida;
		}
	}
//}
</script>
</html>